#!/bin/bash

set -e

GAMEDIR=$SNAP_USER_COMMON/saves_and_config
OLDGAMEDIR=$SNAP_USER_DATA/saves_and_config

if [ "$SNAP_ARCH" == "amd64" ]; then
  ARCH="x86_64-linux-gnu"
elif [ "$SNAP_ARCH" == "armhf" ]; then
  ARCH="arm-linux-gnueabihf"
elif [ "$SNAP_ARCH" == "arm64" ]; then
  ARCH="aarch64-linux-gnu"
else
   ARCH="$SNAP_ARCH-linux-gnu"
fi

export LD_LIBRARY_PATH=$SNAP/usr/lib/$ARCH:$LD_LIBRARY_PATH

# XKB config
export XKB_CONFIG_ROOT=$SNAP/usr/share/X11/xkb

export LD_LIBRARY_PATH=$SNAP/usr/lib/$ARCH/pulseaudio:$LD_LIBRARY_PATH

# Mesa Libs
export LD_LIBRARY_PATH=$SNAP/usr/lib/$ARCH/mesa:$LD_LIBRARY_PATH
export LD_LIBRARY_PATH=$SNAP/usr/lib/$ARCH/mesa-egl:$LD_LIBRARY_PATH

# XDG Config
export XDG_CONFIG_DIRS=$SNAP/etc/xdg:$XDG_CONFIG_DIRS
export XDG_CONFIG_DIRS=$SNAP/usr/xdg:$XDG_CONFIG_DIRS
# Note: this doesn't seem to work, QML's LocalStorage either ignores
# or fails to use $SNAP_USER_DATA if defined here
export XDG_DATA_DIRS=$SNAP_USER_DATA:$XDG_DATA_DIRS
export XDG_DATA_DIRS=$SNAP/usr/share:$XDG_DATA_DIRS

# Workaround in snapd for proprietary nVidia drivers mounts the drivers in
# /var/lib/snapd/lib/gl that needs to be in LD_LIBRARY_PATH
export LD_LIBRARY_PATH=/var/lib/snapd/lib/gl:$LD_LIBRARY_PATH

# Not good, needed for fontconfig
export XDG_DATA_HOME=$SNAP_USER_DATA/usr/share

# Font Config
export FONTCONFIG_PATH=$SNAP/etc/fonts/config.d
export FONTCONFIG_FILE=$SNAP/etc/fonts/fonts.conf

# Tell libGL where to find the drivers
export LIBGL_DRIVERS_PATH=$SNAP/usr/lib/$ARCH/dri

# Necessary for the SDK to find the translations directory
export APP_DIR=$SNAP

# Use GTK styling for running under Unity 7
export DESKTOP_SESSION=ubuntu
export XDG_SESSION_DESKTOP=ubuntu
export XDG_CURRENT_DESKTOP=Unity

#export LIBGL_DEBUG="verbose"

export XLOCALEDIR="$SNAP/usr/share/X11/locale"
export LOCPATH="$SNAP/usr/lib/locale"

SDL_AUDIODRIVER=pulse

if [ ! -d $GAMEDIR ];
then
  echo "Game directory doesn't exist"
  echo "Creating directory"
  mkdir -p $GAMEDIR
  if [ -d $OLDGAMEDIR ];
  then
    echo "Old game directory exists at $OLDGAMEDIR"
    if [ ! -f $OLDGAMEDIR/FILES_HAVE_MOVED ];
    then
      echo "Moving files to new directory to prevent problems on automatic updates"
      cp $OLDGAMEDIR/* $GAMEDIR
      cat > $OLDGAMEDIR/FILES_HAVE_MOVED << EOF
The files in this directory are no longer used by Blade of Agony. The working
versions are in $GAMEDIR .

Feel free to delete these files and the $OLDGAMEDIR directory.
EOF
    else
      echo "Old game files are ignored. Using $GAMEDIR instead"
    fi
  fi
fi

cd ${SNAP}/share/games/doom
${SNAP}/bin/gzdoom -iwad ${SNAP}/usr/share/games/doom/freedoom2.wad -config ${GAMEDIR}/boa.conf -savedir ${GAMEDIR} -file ${SNAP}/wolf_boa.pk3
